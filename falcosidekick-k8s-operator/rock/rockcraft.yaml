# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

name: falcosidekick
# renovate: base: ubuntu:24.04@sha256:c35e29c9450151419d9448b0fd75374fec4fff364a27f176fb458d472dfc9e54
base: ubuntu@24.04
adopt-info: "falcosidekick"
summary: Falcosidekick - Connect Falco to your ecosystem
description: |
  A simple daemon for connecting Falco to your ecosystem. It takes a Falco events and forward them
  to different outputs in a fan-out way. It works as a single endpoint for as many as you want
  Falco instances.

platforms:
  amd64:

services:
  falcosidekick:
    startup: enabled
    override: replace
    summary: Falcosidekick service
    command: falcosidekick -c /etc/falcosidekick/falcosidekick.yaml

# See https://github.com/falcosecurity/falcosidekick/tree/master?tab=readme-ov-file#endpoints
# The port 2801 is the default port, and it can be changed in the configuration file.
checks:
  health:
    level: alive
    override: replace
    http:
      url: "http://localhost:2801/healthz"

parts:
  falcosidekick:
    plugin: go
    source: https://github.com/falcosecurity/falcosidekick.git
    # renovate: depName=falcosecurity/falcosidekick
    source-tag: "2.32.0"
    build-snaps:
      - go/1.25/stable
    build-packages:
      - make
    override-build: |
      craftctl default
      make falcosidekick
    override-prime: |
      craftctl default
      craftctl set version="$(git -C $CRAFT_PART_SRC describe --abbrev --tags)"

  falcosidekick-config:
    plugin: dump
    source: falcosidekick.yaml
    source-type: file
    organize:
      falcosidekick.yaml: etc/falcosidekick/falcosidekick.yaml
    prime:
      - etc/falcosidekick/falcosidekick.yaml
