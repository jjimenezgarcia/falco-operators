# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

# Attention: valid for K8s charms only

name: Terraform module tests

on:
  pull_request:
    paths:
      - "falco-operator/terraform/**"
      - "falcosidekick-operator/terraform/**"

permissions:
  contents: read

jobs:
  test-terraform:
    # remove this condition for enabling the workflow
    if: false
    name: Test Terraform with Juju
    runs-on: ubuntu-latest
    strategy:
      matrix:
        working_dir: [falco-operator, falcosidekick-k8s-operator]
    steps:
    - uses: actions/checkout@v6.0.1
    - uses: charmed-kubernetes/actions-operator@main
      with:
        provider: "microk8s"
        channel: 1.34-strict/stable
        juju-channel: 3.6/stable
    - name: Prepare juju tf provider environment
      run: |
        CONTROLLER=$(juju whoami | yq .Controller)
        JUJU_CONTROLLER_ADDRESSES="$(juju show-controller | yq '.[$CONTROLLER]'.details.\"api-endpoints\" | tr -d "[]' "|tr -d '"'|tr -d '\n')"
        JUJU_USERNAME="$(cat ~/.local/share/juju/accounts.yaml | yq .controllers.$CONTROLLER.user|tr -d '"')"
        JUJU_PASSWORD="$(cat ~/.local/share/juju/accounts.yaml | yq .controllers.$CONTROLLER.password|tr -d '"')"

        echo "JUJU_CONTROLLER_ADDRESSES=$JUJU_CONTROLLER_ADDRESSES" >> "$GITHUB_ENV"
        echo "JUJU_USERNAME=$JUJU_USERNAME" >> "$GITHUB_ENV"
        echo "JUJU_PASSWORD=$JUJU_PASSWORD" >> "$GITHUB_ENV"
        {
          echo 'JUJU_CA_CERT<<EOF'
          juju show-controller $(echo $CONTROLLER|tr -d '"') | yq '.[$CONTROLLER]'.details.\"ca-cert\"|tr -d '"'
          echo EOF
        } >> "$GITHUB_ENV"
    - uses: hashicorp/setup-terraform@v3.1.2
    - run: terraform init
      working-directory: ${{matrix.working_dir}}/terraform
    - run: terraform plan -out=tfplan
      working-directory: ${{matrix.working_dir}}/terraform
    - run: terraform show tfplan
      working-directory: ${{matrix.working_dir}}/terraform
    - run: |
        juju add-model prod-chat-example
        set -e  # Exit on error
        terraform test || { echo "Terraform test failed"; exit 1; }
      working-directory: ${{matrix.working_dir}}/terraform
